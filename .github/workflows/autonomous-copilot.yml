name: Autonomous Copilot Manager

on:
  pull_request:
    types:
      - opened
      - reopened
      - ready_for_review
      - review_requested
      - synchronize
  schedule:
    - cron: "*/10 * * * *"
  workflow_run:
    workflows: ["*"]
    types:
      - requested
      - completed
  workflow_dispatch: 

jobs:
  autonomous-manager:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: write

    steps:
      - name: Install gh CLI (if needed)
        run: sudo apt-get install gh -y

      - name: Enable Debug Mode
        run: set -x

      #########################################################
      # 1. Fallback: Mark Draft PRs Ready if Idle for 30 Minutes
      #########################################################
      - name: Mark Draft PRs Ready (Fallback)
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "üîç Fetching draft PRs (API-only)..."
          PRS=$(gh api repos/${{ github.repository }}/pulls \
            --jq '.[] | select(.draft==true) | .number')

          if [ -z "$PRS" ]; then
            echo "‚úÖ No draft PRs found."
          fi

          for PR in $PRS; do
            echo "üîπ Processing Draft PR #$PR"

            LAST_COMMIT=$(gh api repos/${{ github.repository }}/pulls/$PR/commits \
              --jq '.[-1].commit.committer.date')

            echo "üïí Last commit timestamp for PR #$PR: $LAST_COMMIT"

            MINUTES=$(( ( $(date +%s) - $(date -d "$LAST_COMMIT" +%s) ) / 60 ))
            echo "‚è≥ PR #$PR: Last commit was $MINUTES minutes ago"

            if [ $MINUTES -ge 30 ]; then
              echo "‚úÖ Marking PR #$PR Ready for Review"
              gh pr ready $PR --repo ${{ github.repository }}
            else
              echo "‚è∏ Skipping PR #$PR (only $MINUTES minutes idle)"
            fi
          done

      #########################################################
      # 2. Auto-Approve Pending Workflow Runs
      #########################################################
      - name: Approve Pending Workflow Runs
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "üîÑ Checking for pending workflow approvals..."
          RUNS=$(gh run list --repo ${{ github.repository }} \
            --json databaseId,status,workflowName \
            --jq '.[] | select(.status=="waiting") | "\(.databaseId) - \(.workflowName)"')

          if [ -z "$RUNS" ]; then
            echo "‚úÖ No workflows awaiting approval."
          else
            echo "üîπ Workflows needing approval: $RUNS"
            for RUN_ID in $(echo "$RUNS" | awk '{print $1}'); do
              echo "‚úÖ Approving workflow run $RUN_ID"
              gh api --method POST repos/${{ github.repository }}/actions/runs/$RUN_ID/approve
            done
          fi

      #########################################################
      # 3. Resolve Merge Conflicts with Copilot
      #########################################################
      - name: Resolve Merge Conflicts with Copilot
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "üîç Checking for merge conflicts on PR #${{ github.event.number }}..."
          MERGEABLE=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.number }} \
            --jq '.mergeable')

          echo "üîπ Mergeable status: $MERGEABLE"

          if [ "$MERGEABLE" = "false" ]; then
            echo "‚ö†Ô∏è Conflicts detected! Asking Copilot SWE Agent to resolve..."
            gh pr comment ${{ github.event.number }} \
              --repo ${{ github.repository }} \
              --body "@copilot resolve merge conflicts and push the fixed version."
          else
            echo "‚úÖ No conflicts detected."
          fi

      #########################################################
      # 4. Approve PR (Self-Review)
      #########################################################
      - name: Approve PR on Review Request
        if: github.event.action == 'review_requested' || github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "‚úÖ Approving PR #${{ github.event.number }}"
          gh pr review ${{ github.event.number }} \
            --repo ${{ github.repository }} --approve

      #########################################################
      # 5. Auto-Merge PR Once Checks Pass
      #########################################################
      - name: Merge PR Automatically
        if: github.event.action == 'review_requested' || github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "‚úÖ Attempting to merge PR #${{ github.event.number }}"
          gh pr merge ${{ github.event.number }} \
            --repo ${{ github.repository }} --auto --merge
